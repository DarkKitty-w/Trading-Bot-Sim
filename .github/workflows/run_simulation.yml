name: Run Crypto Simulator - Multi Capital (3 Python Files)

on:
  workflow_dispatch:  # manual trigger

defaults:
  run:
    shell: bash  # ensure bash syntax works on Ubuntu

jobs:
  run-simulations:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      matrix:
        capital: [10, 100, 1000]  # each corresponds to a simulator_X.py file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib requests seaborn plotly scipy

      - name: Create output directories
        run: |
          mkdir -p outputs/${{ matrix.capital }}/charts

      - name: Run simulator_${{ matrix.capital }}.py
        run: |
          python simulator_${{ matrix.capital }}.py | tee outputs/${{ matrix.capital }}/simulation_output_${{ matrix.capital }}.txt

      - name: Upload all results
        uses: actions/upload-artifact@v4
        with:
          name: simulation-${{ matrix.capital }}-results
          path: outputs/${{ matrix.capital }}/**
          retention-days: 30

  generate-comparison-report:
    runs-on: ubuntu-latest
    needs: run-simulations
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate comparison report
        run: |
          echo "ðŸ“Š CAPITAL COMPARISON REPORT" > comparison_report.md
          echo "=============================" >> comparison_report.md
          echo "" >> comparison_report.md
          echo "Generated: $(date)" >> comparison_report.md
          echo "" >> comparison_report.md
          python3 << 'EOF' >> comparison_report.md
import json, os

for capital in [10, 100, 1000]:
    file_path = f"artifacts/simulation-{capital}-results/summary_results.json"
    if os.path.exists(file_path):
        print(f"## ${capital} Simulation\n")
        with open(file_path) as f:
            data = json.load(f)
        for strategy, metrics in data.items():
            print(f"**{strategy}**:")
            print(f"- Return: {metrics.get('Return', 0):.2f}%")
            print(f"- Final Value: ${metrics.get('Final Value', 0):.2f}")
            print(f"- Sharpe Ratio: {metrics.get('Sharpe Ratio', 0):.2f}")
            print(f"- Trades: {metrics.get('Trades', 0)}\n")
        print("---\n")
EOF

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison_report.md
          retention-days: 30
